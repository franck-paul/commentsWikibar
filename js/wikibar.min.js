"use strict";void 0===window.dotclear&&(window.dotclear={}),dotclear.wikibar={resize_timer:void 0,previous_width:0,component:{dialog:class{constructor(e){this.confirm_label=e?.confirm_label||"Ok",this.cancel_label=e?.cancel_label||"Cancel",this.fields=e?.fields}prompt(){return new Promise((e=>{this.fields||e(null);const t=this.fields.reduce(((e,t)=>`${e}<p class="fieldset">${t.html}</p>`),""),i=document.createElement("template");i.innerHTML=`<dialog class="jstDialog"><form method="dialog">${t}<p class="form-buttons"><button name="cancel" class="reset">${this.cancel_label}</button><button type="submit" name="confirm" class="submit">${this.confirm_label}</button></p></form></dialog>`;const s=i.content.firstChild,n=s.querySelectorAll(".fieldset input, .fieldset select");let l=0;for(const e of n)this.fields[l]?.default&&(e.value=this.fields[l].default),l++;document.body.appendChild(s);const o=()=>JSON.stringify(Array.from(n).map((e=>e.value)));for(const e of n)e.addEventListener("keydown",(e=>{"Enter"===e.key&&(e.preventDefault(),s.returnValue=o(),s.close())}));s.querySelector('button[name="confirm"]')?.addEventListener("click",(e=>{e.preventDefault(),s.returnValue=o(),s.close()})),s.querySelector('button[name="cancel"]')?.addEventListener("click",(()=>{s.dispatchEvent(new Event("cancel"))})),s.addEventListener("cancel",(function t(i){i.preventDefault(),s.removeEventListener("close",t),s.returnValue=null,document.body.removeChild(s),e(null)})),s.addEventListener("close",(function t(i){i.preventDefault(),s.removeEventListener("close",t);const n=s.returnValue;document.body.removeChild(s),e(n)})),s.showModal(),n[0].focus()}))}},button:class{constructor(e,t,i,s){this.title=e||null,this.fn=t||(()=>{}),this.scope=i||null,this.className=s||null,this.toolbar_node=null}draw(){if(!this.scope)return null;const e=document.createElement("button");e.setAttribute("type","button"),this.className&&(e.className=this.className);const t=document.createElement("span");t.className="sr-only",t.appendChild(document.createTextNode(this.title)),e.appendChild(t);const i=document.createElement("span");return i.className="jstb_icon",i.addEventListener("mouseover",this.mouseOverChild),i.addEventListener("mouseLeave",this.mouseLeaveChild),e.appendChild(i),e.addEventListener("keydown",this.keyDown),e.addEventListener("focus",this.focus),e.addEventListener("blur",this.blur),e.addEventListener("mouseover",this.mouseOver),e.addEventListener("mouseleave",this.mouseLeave),"function"==typeof this.fn&&e.addEventListener("click",(e=>{try{this.fn.apply(this.scope,e)}catch(e){console.log(e)}return!1})),e}keyDown(e){let t=!1;switch(e.keyCode){case 13:case 32:default:break;case 39:case 40:this.toolbar_node.moveFocus(this,"next"),t=!0;break;case 37:case 38:this.toolbar_node.moveFocus(this,"previous"),t=!0;break;case 36:this.toolbar_node.firstItem.focus(),t=!0;break;case 35:this.toolbar_node.lastItem.focus(),t=!0}t&&(e.stopPropagation(),e.preventDefault())}blur(e){e.target.firstChild.classList.add("sr-only"),document.querySelector(".jstElements").classList.remove("focus")}focus(e){this.toolbar_node.hideAllTooltips(),e.target.firstChild.classList.remove("sr-only"),document.querySelector(".jstElements").classList.add("focus")}mouseLeave(e){"BUTTON"===e.target.nodeName&&(e.target.classList.remove("hovered"),setTimeout((()=>{e.target.classList.contains("hovered")||e.target.firstChild.classList.add("sr-only")}),800))}mouseLeaveChild(e){if("SPAN"!==e.target.nodeName||!e.target.classList.contains("jstb_icon"))return;const t=e.target.parentNode;t.classList.remove("hovered"),setTimeout((()=>{t.classList.contains("hovered")||t.firstChild.classList.add("sr-only")}),800)}mouseOver(e){"BUTTON"===e.target.nodeName&&(this.toolbar_node.hideAllTooltips(),e.target.firstChild.classList.remove("sr-only"),e.target.classList.add("hovered"))}mouseOverChild(e){if("SPAN"!==e.target.nodeName||!e.target.classList.contains("jstb_icon"))return;const t=e.target.parentNode;this.parentNode.toolbar_node.hideAllTooltips(),t.firstChild.classList.remove("sr-only"),t.classList.add("hovered")}},space:class{constructor(e){this.id=e||null,this.width=null}draw(){const e=document.createElement("span");return this.id&&(e.id=this.id),e.appendChild(document.createTextNode(String.fromCharCode(160))),e.setAttribute("aria-hidden","true"),e.className="jstSpacer",this.width&&(e.style.marginRight=`${this.width}px`),e}},combo:class{constructor(e,t,i,s,n){this.title=e||null,this.options=t||null,this.scope=i||null,this.fn=s||(()=>{}),this.className=n||null,this.toolbar_node=null}draw(){if(!this.scope||!this.options)return null;const e=document.createElement("select");this.className&&(e.className=this.className),e.title=this.title;for(const t in this.options){const i=document.createElement("option");i.value=t,i.appendChild(document.createTextNode(this.options[t])),e.appendChild(i)}const t=this;return e.onchange=function(){try{t.fn.call(t.scope,this.value)}catch(e){window.alert(e)}return!1},e}}},toolbar:class{constructor(e,t="",i="wiki",s="",n=null,l={}){document.createElement&&e&&(void 0===document.selection&&void 0===e.setSelectionRange||(this.textarea=e,this.base_url=t,this.mode=i,this.label=s,this.foreign_dialog=l?.foreign,this.link_dialog=l?.link,this.cite_dialog=l?.cite,this.editor=document.createElement("div"),this.editor.className="jstEditor",this.textarea.parentNode.insertBefore(this.editor,this.textarea),this.editor.appendChild(this.textarea),this.toolbar=document.createElement("div"),this.toolbar.className="jstElements",this.toolbar.setAttribute("role","toolbar"),this.toolbar.setAttribute("aria-label",this.label),this.toolbar.setAttribute("aria-controls","c_content"),this.editor.parentNode.insertBefore(this.toolbar,this.editor),this.context=null,this.elements={strong:{type:"button",title:"Strong emphasis",fn:{wiki(){this.singleTag("__")},markdown(){this.singleTag("**")}}},em:{type:"button",title:"Emphasis",fn:{wiki(){this.singleTag("''")},markdown(){this.singleTag("*")}}},ins:{type:"button",title:"Inserted",fn:{wiki(){this.singleTag("++")},markdown(){this.singleTag("<ins>","</ins>")}}},del:{type:"button",title:"Deleted",fn:{wiki(){this.singleTag("--")},markdown(){this.singleTag("<del>","</del>")}}},quote:{type:"button",title:"Inline quote",fn:{async wiki(){await this.elements.quote.prompt.call(this,(e=>{let t="";e.lang&&(t=`${t}|${e.lang}`),e.cite&&(e.lang||(t=`${t}|`),t=`${t}|${e.cite}`),t=`${t}}}`,this.encloseSelection("{{",t)}))},async markdown(){await this.elements.quote.prompt.call(this,(e=>{let t="<q";e.cite&&(t=`${t} cite="${e.cite}"`),e.lang&&(t=`${t} lang="${e.lang}"`),t=`${t}>`,this.encloseSelection(t,"</q>")}))}},async prompt(e=null){const t=new dotclear.wikibar.component.dialog({confirm_label:this.cite_dialog.ok,cancel_label:this.cite_dialog.cancel,fields:[{default:this.cite_dialog.default_url,html:this.cite_dialog.url},{default:this.cite_dialog.default_lang,html:this.cite_dialog.language}]});await t.prompt().then((t=>{if(t&&e){const i=JSON.parse(t);e({cite:this.stripBaseURL(i[0]),lang:i[1]})}}))}},code:{type:"button",title:"Code",fn:{wiki(){this.singleTag("@@")},markdown(){this.singleTag("`")}}},foreign:{type:"button",title:"Foreign text",fn:{async wiki(){await this.elements.foreign.prompt.call(this,(e=>{this.encloseSelection("££",`|${e.lang}££`)}))},async markdown(){await this.elements.foreign.prompt.call(this,(e=>{this.encloseSelection(`<i lang="${e.lang}">`,"</i>")}))}},async prompt(e=null){const t=new dotclear.wikibar.component.dialog({confirm_label:this.foreign_dialog.ok,cancel_label:this.foreign_dialog.cancel,fields:[{default:this.foreign_dialog.default_lang,html:this.foreign_dialog.language}]});await t.prompt().then((t=>{if(t&&e){const i=JSON.parse(t);e({lang:i[0]})}}))}},br:{type:"button",title:"Line break",fn:{wiki(){this.encloseSelection("%%%\n","")},markdown(){this.encloseSelection("  \n","")}}},ul:{type:"button",title:"Unordered list",fn:{wiki(){this.encloseSelection("","",(e=>`* ${e.replace(/\r/g,"").replace(/\n/g,"\n* ")}`))},markdown(){this.encloseSelection("","",(e=>`* ${e.replace(/\r/g,"").replace(/\n/g,"\n* ")}`))}}},ol:{type:"button",title:"Ordered list",fn:{wiki(){this.encloseSelection("","",(e=>`# ${e.replace(/\r/g,"").replace(/\n/g,"\n# ")}`))},markdown(){this.encloseSelection("","",(e=>`1. ${e.replace(/\r/g,"").replace(/\n/g,"\n1. ")}`))}}},pre:{type:"button",title:"Preformatted",fn:{wiki(){this.encloseSelection("","",(e=>` ${e.replace(/\r/g,"").replace(/\n/g,"\n ")}`))},markdown(){this.encloseSelection("\n","",(e=>`    ${e.replace(/\r/g,"").replace(/\n/g,"\n    ")}`))}}},bquote:{type:"button",title:"Block quote",fn:{wiki(){this.encloseSelection("","",(e=>`> ${e.replace(/\r/g,"").replace(/\n/g,"\n> ")}`))},markdown(){this.encloseSelection("\n","",(e=>`> ${e.replace(/\r/g,"").replace(/\n/g,"\n> ")}`))}}},link:{type:"button",title:"Link",fn:{async wiki(){await this.elements.link.prompt.call(this,(e=>{if(!e)return;let t=`|${e.href}`;e.hreflang&&(t=`${t}|${e.hreflang}`),e.title&&(e.hreflang||(t=`${t}|`),t=`${t}|${e.title}`),t=`${t}]`,this.encloseSelection("[",t)}))},async markdown(){await this.elements.link.prompt.call(this,(e=>{if(!e)return;let t=`](${e.href}`;e.title&&(t=`${t} "${e.title}"`),t=`${t})`,e.hreflang&&(t=`${t}{hreflang=${e.hreflang}}`),this.encloseSelection("[",t)}))}},async prompt(e=null){const t=new dotclear.wikibar.component.dialog({confirm_label:this.link_dialog.ok,cancel_label:this.link_dialog.cancel,fields:[{default:this.link_dialog.default_href,html:this.link_dialog.href},{default:this.link_dialog.default_title,html:this.link_dialog.title},{default:this.link_dialog.default_hreflang,html:this.link_dialog.language}]});await t.prompt().then((t=>{if(t&&e){const i=JSON.parse(t);i[0]&&e({href:this.stripBaseURL(i[0]),title:i[1],hreflang:i[2]})}}))}}},n&&dotclear.mergeDeep(this.elements,n),window.addEventListener("resize",(()=>{void 0!==dotclear.resize_timer&&clearTimeout(dotclear.resize_timer),dotclear.resize_timer=setTimeout((()=>{document.documentElement.clientWidth!==dotclear.wikibar.previous_width&&(this.updateTooltipsPos(),dotclear.wikibar.previous_width=document.documentElement.clientWidth)}),250)}))))}getMode(){return this.mode}setMode(e){this.mode=e||"wiki"}switchMode(e="wiki"){this.draw(e)}button(e){const t=this.elements[e];return"function"!=typeof t.fn[this.mode]?null:new dotclear.wikibar.component.button(t.title,t.fn[this.mode],this,`jstb_${e}`)}space(e){const t=new dotclear.wikibar.component.space(e);return void 0!==this.elements[e].width&&(t.width=this.elements[e].width),t}combo(e){const t=this.elements[e];if("function"!=typeof t[this.mode].fn||0===t[this.mode].list.length)return null;const i={};for(const e of t[this.mode].list)i[e]=t.options[e];return new dotclear.wikibar.component.combo(t.title,i,this,t[this.mode].fn)}draw(e){for(this.setMode(e);this.toolbar.hasChildNodes();)this.toolbar.removeChild(this.toolbar.firstChild);for(const e in this.elements){const t=this.elements[e],i=void 0===t.type||""===t.type||void 0!==t.disabled&&t.disabled||void 0!==t.context&&null!=t.context&&t.context!==this.context;if(!i&&"function"==typeof this[t.type]){const i=this[t.type](e);if(i){const e=i.draw();e&&(this.toolbar.appendChild(e),e.toolbar_node=this)}}}this.firstItem=document.querySelector(".jstElements button:first-child"),this.lastItem=document.querySelector(".jstElements button:last-child"),this.items=Array.from(document.querySelectorAll(".jstElements button")),this.updateTooltipsPos(),document.body.addEventListener("keydown",this.keyDown.bind(this))}keyDown(e){27===e.keyCode&&this.hideAllTooltips()}singleTag(e=null,t=e){e&&t&&this.encloseSelection(e,t)}encloseSelection(e="",t="",i=null){let s,n,l,o,a,r;this.textarea.focus(),void 0!==document.selection?l=document.selection.createRange().text:void 0!==this.textarea.setSelectionRange&&(s=this.textarea.selectionStart,n=this.textarea.selectionEnd,o=this.textarea.scrollTop,l=this.textarea.value.substring(s,n));let c=t;l.match(/ $/)&&(l=l.substring(0,l.length-1),c+=" "),r="function"==typeof i?l?i.call(this,l):i(""):l||"",a=e+r+c,void 0!==document.selection?(document.selection.createRange().text=a,this.textarea.caretPos-=t.length):void 0!==this.textarea.setSelectionRange&&(this.textarea.value=this.textarea.value.substring(0,s)+a+this.textarea.value.substring(n),r.length?this.textarea.setSelectionRange(s+a.length,s+a.length):this.textarea.setSelectionRange(s+e.length,s+e.length),this.textarea.scrollTop=o)}stripBaseURL(e){return""!==this.base_url&&0===e.indexOf(this.base_url)?e.substring(this.base_url.length):e}moveFocus(e,t){let i;i="previous"===t?e===this.firstItem?this.lastItem:this.items[this.items.indexOf(e)-1]:e===this.lastItem?this.firstItem:this.items[this.items.indexOf(e)+1],i.focus()}updateTooltipsPos(){for(const e of document.querySelectorAll(".jstElements button span")){if(e.classList.contains("jstb_icon"))continue;const t=e.parentNode.getBoundingClientRect().left;e.style.left="0px",e.classList.add("hidden"),e.classList.remove("sr-only");const i=e.clientWidth;if(e.classList.add("sr-only"),e.classList.remove("hidden"),i+t>document.documentElement.clientWidth-15){const s=Math.trunc(-1*(i+t-document.documentElement.clientWidth+15));e.style.left=`${s}px`}}}hideAllTooltips(){for(const e of document.querySelectorAll(".jstElements button span"))e.classList.contains("jstb_icon")||e.classList.add("sr-only")}}};
