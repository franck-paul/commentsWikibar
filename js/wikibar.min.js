"use strict";void 0===window.dotclear&&(window.dotclear={}),dotclear.wikibar={resize_timer:void 0,previous_width:0,component:{dialog:class{title;confirm_label;cancel_label;fields;constructor({title:t,confirm_label:e,cancel_label:i,fields:s}={}){this.title=t,this.confirm_label=e??"Ok",this.cancel_label=i??"Cancel",this.fields=s}prompt(){if(!this.fields?.length)return Promise.resolve(null);const t=document.createElement("template"),e=this.fields.map(t=>`<p class="field">${t.html}</p>`).join(""),i=this.title?`<h1>${this.title}</h1>`:"";t.innerHTML=((t,...e)=>t.reduce((t,i,s)=>t+i+(e[s]??""),""))`
          <dialog class="jstDialog">
            ${i}
            <form method="dialog">
              ${e}
              <p class="form-buttons">
                <button name="cancel" class="reset">${this.cancel_label}</button>
                <button type="submit" name="confirm" class="submit">${this.confirm_label}</button>
              </p>
            </form>
          </dialog>
        `;const s=t.content.firstElementChild,l=s.querySelectorAll(".field input, .field select");let o=0;for(const t of l)this.fields[o]?.default&&(t.value=this.fields[o].default),o++;document.body.appendChild(s);const n=()=>JSON.stringify([...l].map(t=>t.value));return new Promise(t=>{for(const t of l)t.addEventListener("keydown",t=>{"Enter"===t.key&&(t.preventDefault(),s.returnValue=n(),s.close())});s.querySelector('button[name="confirm"]')?.addEventListener("click",t=>{t.preventDefault(),s.returnValue=n(),s.close()}),s.querySelector('button[name="cancel"]')?.addEventListener("click",()=>{s.dispatchEvent(new Event("cancel"))}),s.addEventListener("cancel",function e(i){i.preventDefault(),s.removeEventListener("close",e),s.returnValue=null,s.remove(),t(null)}),s.addEventListener("close",function e(i){i.preventDefault(),s.removeEventListener("close",e);const l=s.returnValue;s.remove(),t(l)}),s.showModal(),l[0].focus()})}},button:class{title;fn;scope;className;toolbar_node=null;constructor(t,e,i,s){this.title=t??"",this.fn=e??(()=>{}),this.scope=i,this.className=s??null}draw(){if(!this.scope)return null;const t=document.createElement("button");t.setAttribute("type","button"),this.className&&(t.className=this.className);const e=document.createElement("span");e.className="sr-only",e.appendChild(document.createTextNode(this.title)),t.appendChild(e);const i=document.createElement("span");return i.className="jstb_icon",i.addEventListener("mouseover",this.mouseOverChild),i.addEventListener("mouseLeave",this.mouseLeaveChild),t.appendChild(i),t.addEventListener("keydown",this.keyDown),t.addEventListener("focus",this.focus),t.addEventListener("blur",this.blur),t.addEventListener("mouseover",this.mouseOver),t.addEventListener("mouseleave",this.mouseLeave),"function"==typeof this.fn&&t.addEventListener("click",t=>{try{this.fn.call(this.scope,t)}catch(t){console.log(t)}}),t}keyDown(t){let e=!1;switch(t.code){case"Enter":case"Space":default:break;case"ArrowRight":case"ArrowDown":this.toolbar_node.moveFocus(this,"next"),e=!0;break;case"ArrowLeft":case"ArrowUp":this.toolbar_node.moveFocus(this,"previous"),e=!0;break;case"Home":this.toolbar_node.firstItem.focus(),e=!0;break;case"End":this.toolbar_node.lastItem.focus(),e=!0}e&&(t.stopPropagation(),t.preventDefault())}blur(t){t.target.firstChild.classList.add("sr-only"),document.querySelector(".jstElements").classList.remove("focus")}focus(t){this.toolbar_node.hideAllTooltips(),t.target.firstChild.classList.remove("sr-only"),document.querySelector(".jstElements").classList.add("focus")}mouseLeave(t){"BUTTON"===t.target.nodeName&&(t.target.classList.remove("hovered"),setTimeout(()=>{t.target.classList.contains("hovered")||t.target.firstChild.classList.add("sr-only")},800))}mouseLeaveChild(t){if("SPAN"!==t.target.nodeName||!t.target.classList.contains("jstb_icon"))return;const e=t.target.parentNode;e.classList.remove("hovered"),setTimeout(()=>{e.classList.contains("hovered")||e.firstChild.classList.add("sr-only")},800)}mouseOver(t){"BUTTON"===t.target.nodeName&&(this.toolbar_node.hideAllTooltips(),t.target.firstChild.classList.remove("sr-only"),t.target.classList.add("hovered"))}mouseOverChild(t){if("SPAN"!==t.target.nodeName||!t.target.classList.contains("jstb_icon"))return;const e=t.target.parentNode;this.parentNode.toolbar_node.hideAllTooltips(),e.firstChild.classList.remove("sr-only"),e.classList.add("hovered")}},space:class{id=null;width=null;constructor(t){this.id=t??null}draw(){const t=document.createElement("span");return t.id=this.id??void 0,t.textContent=" ",t.setAttribute("aria-hidden","true"),t.className="jstSpacer",null!==this.width&&(t.style.marginRight=`${this.width}px`),t}},combo:class{title;options;scope;fn;className;toolbar_node=null;constructor(t,e,i,s,l){this.title=t??null,this.options=e,this.scope=i,this.fn=s??(()=>{}),this.className=l??null}draw(){if(!this.scope||!this.options)return null;const t=document.createElement("select");this.className&&(t.className=this.className),t.title=this.title;for(const e in this.options){const i=document.createElement("option");i.value=e,i.appendChild(document.createTextNode(this.options[e])),t.appendChild(i)}const e=this;return t.onchange=function(){try{e.fn.call(e.scope,this.value)}catch(t){window.alert(t)}return!1},t}}},toolbar:class{constructor(t,e="",i="wiki",s="",l=null,o={}){document.createElement&&t&&(void 0===document.selection&&void 0===t.setSelectionRange||(this.textarea=t,this.base_url=e,this.mode=i,this.label=s,this.foreign_dialog=o?.foreign,this.link_dialog=o?.link,this.cite_dialog=o?.cite,this.editor=document.createElement("div"),this.editor.className="jstEditor",this.textarea.parentNode.insertBefore(this.editor,this.textarea),this.editor.appendChild(this.textarea),this.toolbar=document.createElement("div"),this.toolbar.className="jstElements",this.toolbar.setAttribute("role","toolbar"),this.toolbar.setAttribute("aria-label",this.label),this.toolbar.setAttribute("aria-controls","c_content"),this.editor.parentNode.insertBefore(this.toolbar,this.editor),this.context=null,this.elements={strong:{group:"format",type:"button",title:"Strong emphasis",fn:{wiki(){this.singleTag("__")},markdown(){this.singleTag("**")}}},em:{group:"format",type:"button",title:"Emphasis",fn:{wiki(){this.singleTag("''")},markdown(){this.singleTag("*")}}},ins:{group:"format",type:"button",title:"Inserted",fn:{wiki(){this.singleTag("++")},markdown(){this.singleTag("<ins>","</ins>")}}},del:{group:"format",type:"button",title:"Deleted",fn:{wiki(){this.singleTag("--")},markdown(){this.singleTag("<del>","</del>")}}},quote:{group:"format",type:"button",title:"Inline quote",fn:{async wiki(){await this.elements.quote.prompt.call(this,t=>{let e="";t.lang&&(e=`${e}|${t.lang}`),t.cite&&(t.lang||(e=`${e}|`),e=`${e}|${t.cite}`),e=`${e}}}`,this.encloseSelection("{{",e)})},async markdown(){await this.elements.quote.prompt.call(this,t=>{let e="<q";t.cite&&(e=`${e} cite="${t.cite}"`),t.lang&&(e=`${e} lang="${t.lang}"`),e=`${e}>`,this.encloseSelection(e,"</q>")})}},async prompt(t=null){const e=new dotclear.wikibar.component.dialog({title:this.cite_dialog?.title||this.title,confirm_label:this.cite_dialog.ok,cancel_label:this.cite_dialog.cancel,fields:[{default:this.cite_dialog.fields.default_url,html:this.cite_dialog.fields.url},{default:this.cite_dialog.fields.default_lang,html:this.cite_dialog.fields.language}]});await e.prompt().then(e=>{if(e&&t){const i=JSON.parse(e);return void t({cite:this.stripBaseURL(i[0]),lang:i[1]})}this.toolbar.querySelector(".jstb_quote").focus()})}},code:{group:"format",type:"button",title:"Code",fn:{wiki(){this.singleTag("@@")},markdown(){this.singleTag("`")}}},foreign:{group:"format",type:"button",title:"Foreign text",fn:{async wiki(){await this.elements.foreign.prompt.call(this,t=>{this.encloseSelection("££",`|${t.lang}££`)})},async markdown(){await this.elements.foreign.prompt.call(this,t=>{this.encloseSelection(`<i lang="${t.lang}">`,"</i>")})}},async prompt(t=null){const e=new dotclear.wikibar.component.dialog({title:this.foreign_dialog?.title||this.title,confirm_label:this.foreign_dialog.ok,cancel_label:this.foreign_dialog.cancel,fields:[{default:this.foreign_dialog.fields.default_lang,html:this.foreign_dialog.fields.language}]});await e.prompt().then(e=>{if(e&&t){const i=JSON.parse(e);return void t({lang:i[0]})}this.toolbar.querySelector(".jstb_foreign").focus()})}},br:{group:"br",type:"button",title:"Line break",fn:{wiki(){this.encloseSelection("%%%\n","")},markdown(){this.encloseSelection("  \n","")}}},ul:{group:"block",type:"button",title:"Unordered list",fn:{wiki(){this.encloseSelection("","",t=>`* ${t.replace(/\r/g,"").replace(/\n/g,"\n* ")}`)},markdown(){this.encloseSelection("","",t=>`* ${t.replace(/\r/g,"").replace(/\n/g,"\n* ")}`)}}},ol:{group:"block",type:"button",title:"Ordered list",fn:{wiki(){this.encloseSelection("","",t=>`# ${t.replace(/\r/g,"").replace(/\n/g,"\n# ")}`)},markdown(){this.encloseSelection("","",t=>`1. ${t.replace(/\r/g,"").replace(/\n/g,"\n1. ")}`)}}},pre:{group:"block",type:"button",title:"Preformatted",fn:{wiki(){this.encloseSelection("","",t=>` ${t.replace(/\r/g,"").replace(/\n/g,"\n ")}`)},markdown(){this.encloseSelection("\n","",t=>`    ${t.replace(/\r/g,"").replace(/\n/g,"\n    ")}`)}}},bquote:{group:"block",type:"button",title:"Block quote",fn:{wiki(){this.encloseSelection("","",t=>`> ${t.replace(/\r/g,"").replace(/\n/g,"\n> ")}`)},markdown(){this.encloseSelection("\n","",t=>`> ${t.replace(/\r/g,"").replace(/\n/g,"\n> ")}`)}}},link:{group:"link",type:"button",title:"Link",fn:{async wiki(){await this.elements.link.prompt.call(this,t=>{if(!t)return;let e=`|${t.href}`;t.hreflang&&(e=`${e}|${t.hreflang}`),t.title&&(t.hreflang||(e=`${e}|`),e=`${e}|${t.title}`),e=`${e}]`,this.encloseSelection("[",e)})},async markdown(){await this.elements.link.prompt.call(this,t=>{if(!t)return;let e=`](${t.href}`;t.title&&(e=`${e} "${t.title}"`),e=`${e})`,t.hreflang&&(e=`${e}{hreflang=${t.hreflang}}`),this.encloseSelection("[",e)})}},async prompt(t=null){const e=new dotclear.wikibar.component.dialog({title:this.link_dialog?.title||this.title,confirm_label:this.link_dialog.ok,cancel_label:this.link_dialog.cancel,fields:[{default:this.link_dialog.fields.default_href,html:this.link_dialog.fields.href},{default:this.link_dialog.fields.default_title,html:this.link_dialog.fields.title},{default:this.link_dialog.fields.default_hreflang,html:this.link_dialog.fields.language}]});await e.prompt().then(e=>{if(e&&t){const i=JSON.parse(e);if(i[0])return void t({href:this.stripBaseURL(i[0]),title:i[1],hreflang:i[2]})}this.toolbar.querySelector(".jstb_link").focus()})}}},l&&dotclear.mergeDeep(this.elements,l),window.addEventListener("resize",()=>{clearTimeout(dotclear.resize_timer),dotclear.resize_timer=setTimeout(()=>{document.documentElement.clientWidth!==dotclear.wikibar.previous_width&&(this.updateTooltipsPos(),dotclear.wikibar.previous_width=document.documentElement.clientWidth)},250)})))}getMode(){return this.mode}setMode(t){this.mode=t??"wiki"}switchMode(t="wiki"){this.draw(t)}button(t){const e=this.elements[t];return"function"!=typeof e.fn[this.mode]?null:new dotclear.wikibar.component.button(e.title,e.fn[this.mode],this,`jstb_${t}`)}space(t){const e=new dotclear.wikibar.component.space(t);return void 0!==this.elements[t].width&&(e.width=this.elements[t].width),e}combo(t){const e=this.elements[t];if("function"!=typeof e[this.mode].fn||0===e[this.mode].list.length)return null;const i={};for(const t of e[this.mode].list)i[t]=e.options[t];return new dotclear.wikibar.component.combo(e.title,i,this,e[this.mode].fn)}draw(t){for(this.setMode(t);this.toolbar.hasChildNodes();)this.toolbar.removeChild(this.toolbar.firstChild);let e,i,s,l;this.toolNodes={};const o=(new DOMParser).parseFromString('<div class="jstGroup"></div>',"text/html").body.firstChild,n=[];l=o.cloneNode(!0);for(const t in this.elements){e=this.elements[t];const a=void 0===e.type||""===e.type||void 0!==e.disabled&&e.disabled||void 0!==e.context&&null!=e.context&&e.context!==this.context;if(!a&&"function"==typeof this[e.type]){s=!1;const a=e?.group;if(i=this[e.type](t),i&&("space"!==e.type?(s=i.draw(),s.toolbar_node=this):(l.childElementCount>0&&n.push(l),l=o.cloneNode(!0))),s){this.toolNodes[t]=s;for(const t of n)if(t.getAttribute("name")===`jstg_${a}`){t.appendChild(s),s=!1;break}s&&(null!==l.getAttribute("name")&&l.getAttribute("name")!==`jstg_${a}`&&(n.push(l),l=o.cloneNode(!0)),l.appendChild(s),void 0!==a&&""!==a&&null===l.getAttribute("name")&&l.setAttribute("name",`jstg_${a}`))}}}l.childElementCount>0&&n.push(l);for(const t of n)t.childElementCount>0&&this.toolbar.appendChild(t);this.firstItem=document.querySelector(".jstElements button:first-child"),this.lastItem=document.querySelector(".jstElements button:last-child"),this.items=Array.from(document.querySelectorAll(".jstElements button")),this.updateTooltipsPos(),document.body.addEventListener("keydown",this.keyDown.bind(this))}keyDown(t){"Escape"===t.code&&this.hideAllTooltips()}singleTag(t=null,e=t){t&&e&&this.encloseSelection(t,e)}encloseSelection(t="",e="",i=null){let s,l,o,n,a,r;this.textarea.focus(),void 0!==document.selection?o=document.selection.createRange().text:void 0!==this.textarea.setSelectionRange&&(s=this.textarea.selectionStart,l=this.textarea.selectionEnd,n=this.textarea.scrollTop,o=this.textarea.value.substring(s,l));let c=e;o.match(/ $/)&&(o=o.substring(0,o.length-1),c+=" "),r="function"==typeof i?o?i.call(this,o):i(""):o||"",a=t+r+c,void 0!==document.selection?(document.selection.createRange().text=a,this.textarea.caretPos-=e.length):void 0!==this.textarea.setSelectionRange&&(this.textarea.value=this.textarea.value.substring(0,s)+a+this.textarea.value.substring(l),r.length?this.textarea.setSelectionRange(s+a.length,s+a.length):this.textarea.setSelectionRange(s+t.length,s+t.length),this.textarea.scrollTop=n)}stripBaseURL(t){return""!==this.base_url&&0===t.indexOf(this.base_url)?t.substring(this.base_url.length):t}moveFocus(t,e){let i;i="previous"===e?t===this.firstItem?this.lastItem:this.items[this.items.indexOf(t)-1]:t===this.lastItem?this.firstItem:this.items[this.items.indexOf(t)+1],i.focus()}updateTooltipsPos(){for(const t of document.querySelectorAll(".jstElements button span")){if(t.classList.contains("jstb_icon"))continue;const e=t.parentNode.getBoundingClientRect().left;t.style.left="0px",t.classList.add("hidden"),t.classList.remove("sr-only");const i=t.clientWidth;if(t.classList.add("sr-only"),t.classList.remove("hidden"),i+e>document.documentElement.clientWidth-15){const s=Math.trunc(-1*(i+e-document.documentElement.clientWidth+15));t.style.left=`${s}px`}}}hideAllTooltips(){for(const t of document.querySelectorAll(".jstElements button span"))t.classList.contains("jstb_icon")||t.classList.add("sr-only")}}};
