"use strict";var dotclear=dotclear||{};dotclear.resizeTimer=void 0,dotclear.prevWidth=0,dotclear.jsDialog=class{constructor(e){this.confirm_label=e?.confirm_label||"Ok",this.cancel_label=e?.cancel_label||"Cancel",this.fields=e?.fields}prompt(){return new Promise((e=>{this.fields||e(null);const t=this.fields.reduce(((e,t)=>`${e}<p class="fieldset">${t.html}</p>`),""),s=document.createElement("template");s.innerHTML=`<dialog class="jstDialog"><form method="dialog">${t}<p class="form-buttons"><button name="cancel" class="reset">${this.cancel_label}</button><button type="submit" name="confirm" class="submit">${this.confirm_label}</button></p></form></dialog>`;const i=s.content.firstChild,l=i.querySelectorAll(".fieldset input, .fieldset select");let n=0;for(const e of l)this.fields[n]?.default&&(e.value=this.fields[n].default),n++;document.body.appendChild(i);const o=()=>JSON.stringify(Array.from(l).map((e=>e.value)));for(const e of l)e.addEventListener("keydown",(e=>{"Enter"===e.key&&(e.preventDefault(),i.returnValue=o(),i.close())}));const a=i.querySelector('button[name="confirm"]');a.addEventListener("click",(e=>{e.preventDefault(),i.returnValue=o(),i.close()}));const r=i.querySelector('button[name="cancel"]');r.addEventListener("click",(()=>{i.dispatchEvent(new Event("cancel"))})),i.addEventListener("cancel",(function t(s){s.preventDefault(),i.removeEventListener("close",t),i.returnValue=null,document.body.removeChild(i),e(null)})),i.addEventListener("close",(function t(s){s.preventDefault(),i.removeEventListener("close",t);const l=i.returnValue;document.body.removeChild(i),e(l)})),i.showModal(),l[0].focus()}))}},dotclear.jsButton=class{constructor(e,t,s,i){this.title=e||null,this.fn=t||(()=>{}),this.scope=s||null,this.className=i||null,this.toolbarNode=null}draw(){if(!this.scope)return null;const e=document.createElement("button");e.setAttribute("type","button"),this.className&&(e.className=this.className);const t=document.createElement("span");t.className="sr-only",t.appendChild(document.createTextNode(this.title)),e.appendChild(t);const s=document.createElement("span");return s.className="jstb_icon",s.addEventListener("mouseover",this.mouseOverChild),s.addEventListener("mouseLeave",this.mouseLeaveChild),e.appendChild(s),e.addEventListener("keydown",this.keyDown),e.addEventListener("focus",this.focus),e.addEventListener("blur",this.blur),e.addEventListener("mouseover",this.mouseOver),e.addEventListener("mouseleave",this.mouseLeave),"function"==typeof this.fn&&e.addEventListener("click",(e=>{try{this.fn.apply(this.scope,e)}catch(e){console.log(e)}return!1})),e}keyDown(e){let t=!1;switch(e.keyCode){case 13:case 32:default:break;case 39:case 40:this.toolbarNode.moveFocus(this,"next"),t=!0;break;case 37:case 38:this.toolbarNode.moveFocus(this,"previous"),t=!0;break;case 36:this.toolbarNode.firstItem.focus(),t=!0;break;case 35:this.toolbarNode.lastItem.focus(),t=!0}t&&(e.stopPropagation(),e.preventDefault())}blur(e){e.target.firstChild.classList.add("sr-only"),document.querySelector(".jstElements").classList.remove("focus")}focus(e){this.toolbarNode.hideAllTooltips(),e.target.firstChild.classList.remove("sr-only"),document.querySelector(".jstElements").classList.add("focus")}mouseLeave(e){"BUTTON"===e.target.nodeName&&(e.target.classList.remove("hovered"),setTimeout((()=>{e.target.classList.contains("hovered")||e.target.firstChild.classList.add("sr-only")}),800))}mouseLeaveChild(e){if("SPAN"!==e.target.nodeName||!e.target.classList.contains("jstb_icon"))return;const t=e.target.parentNode;t.classList.remove("hovered"),setTimeout((()=>{t.classList.contains("hovered")||t.firstChild.classList.add("sr-only")}),800)}mouseOver(e){"BUTTON"===e.target.nodeName&&(this.toolbarNode.hideAllTooltips(),e.target.firstChild.classList.remove("sr-only"),e.target.classList.add("hovered"))}mouseOverChild(e){if("SPAN"!==e.target.nodeName||!e.target.classList.contains("jstb_icon"))return;const t=e.target.parentNode;this.parentNode.toolbarNode.hideAllTooltips(),t.firstChild.classList.remove("sr-only"),t.classList.add("hovered")}},dotclear.jsSpace=class{constructor(e){this.id=e||null,this.width=null}draw(){const e=document.createElement("span");return this.id&&(e.id=this.id),e.appendChild(document.createTextNode(String.fromCharCode(160))),e.setAttribute("aria-hidden","true"),e.className="jstSpacer",this.width&&(e.style.marginRight=`${this.width}px`),e}},dotclear.jsCombo=class{constructor(e,t,s,i,l){this.title=e||null,this.options=t||null,this.scope=s||null,this.fn=i||(()=>{}),this.className=l||null}draw(){if(!this.scope||!this.options)return null;const e=document.createElement("select");this.className&&(e.className=this.className),e.title=this.title;for(const t in this.options){const s=document.createElement("option");s.value=t,s.appendChild(document.createTextNode(this.options[t])),e.appendChild(s)}const t=this;return e.onchange=function(){try{t.fn.call(t.scope,this.value)}catch(e){window.alert(e)}return!1},e}},dotclear.jsToolBar=class{constructor(e,t="",s="wiki",i="",l=null,n={},o={},a={}){document.createElement&&e&&(void 0===document.selection&&void 0===e.setSelectionRange||(this.textarea=e,this.base_url=t,this.mode=s,this.label=i,this.language_dialog=n,this.link_dialog=o,this.cite_dialog=a,this.editor=document.createElement("div"),this.editor.className="jstEditor",this.textarea.parentNode.insertBefore(this.editor,this.textarea),this.editor.appendChild(this.textarea),this.toolbar=document.createElement("div"),this.toolbar.className="jstElements",this.toolbar.setAttribute("role","toolbar"),this.toolbar.setAttribute("aria-label",this.label),this.toolbar.setAttribute("aria-controls","c_content"),this.editor.parentNode.insertBefore(this.toolbar,this.editor),this.context=null,this.toolNodes={},this.elements={strong:{type:"button",title:"Strong emphasis",fn:{wiki(){this.singleTag("__")},markdown(){this.singleTag("**")}}},em:{type:"button",title:"Emphasis",fn:{wiki(){this.singleTag("''")},markdown(){this.singleTag("*")}}},ins:{type:"button",title:"Inserted",fn:{wiki(){this.singleTag("++")},markdown(){this.singleTag("<ins>","</ins>")}}},del:{type:"button",title:"Deleted",fn:{wiki(){this.singleTag("--")},markdown(){this.singleTag("<del>","</del>")}}},quote:{type:"button",title:"Inline quote",fn:{async wiki(){await this.elements.quote.prompt.call(this,(e=>{let t="";e.lang&&(t=`${t}|${e.lang}`),e.cite&&(e.lang||(t=`${t}|`),t=`${t}|${e.cite}`),t=`${t}}}`,this.encloseSelection("{{",t)}))},async markdown(){await this.elements.quote.prompt.call(this,(e=>{let t="<q";t=e.cite?`${t} cite="${e.cite}"`:t,t=e.lang?`${t} lang="${e.lang}"`:t,t=`${t}>`,this.encloseSelection(t,"</q>")}))}},async prompt(e=null){const t=new dotclear.jsDialog({confirm_label:this.cite_dialog.ok,cancel_label:this.cite_dialog.cancel,fields:[{default:this.cite_dialog.default_url,html:this.cite_dialog.url},{default:this.cite_dialog.default_lang,html:this.cite_dialog.language}]});await t.prompt().then((t=>{if(t&&e){const s=JSON.parse(t);e({cite:this.stripBaseURL(s[0]),lang:s[1]})}}))}},code:{type:"button",title:"Code",fn:{wiki(){this.singleTag("@@")},markdown(){this.singleTag("`")}}},foreign:{type:"button",title:"Foreign text",fn:{async wiki(){await this.elements.foreign.prompt.call(this,(e=>{const t=`|${e}££`;this.encloseSelection("££",t)}))},async markdown(){await this.elements.foreign.prompt.call(this,(e=>{const t=`<i lang="${e}">`;this.encloseSelection(t,"</i>")}))}},async prompt(e=null){const t=new dotclear.jsDialog({confirm_label:this.language_dialog.ok,cancel_label:this.language_dialog.cancel,fields:[{default:this.language_dialog.default_lang,html:this.language_dialog.language}]});await t.prompt().then((t=>{if(t&&e){const s=JSON.parse(t);e(s[0])}}))}},br:{type:"button",title:"Line break",fn:{wiki(){this.encloseSelection("%%%\n","")},markdown(){this.encloseSelection("  \n","")}}},ul:{type:"button",title:"Unordered list",fn:{wiki(){this.encloseSelection("","",(e=>`* ${e.replace(/\r/g,"").replace(/\n/g,"\n* ")}`))},markdown(){this.encloseSelection("","",(e=>`* ${e.replace(/\r/g,"").replace(/\n/g,"\n* ")}`))}}},ol:{type:"button",title:"Ordered list",fn:{wiki(){this.encloseSelection("","",(e=>`# ${e.replace(/\r/g,"").replace(/\n/g,"\n# ")}`))},markdown(){this.encloseSelection("","",(e=>`1. ${e.replace(/\r/g,"").replace(/\n/g,"\n1. ")}`))}}},pre:{type:"button",title:"Preformatted",fn:{wiki(){this.encloseSelection("","",(e=>` ${e.replace(/\r/g,"").replace(/\n/g,"\n ")}`))},markdown(){this.encloseSelection("\n","",(e=>`    ${e.replace(/\r/g,"").replace(/\n/g,"\n    ")}`))}}},bquote:{type:"button",title:"Block quote",fn:{wiki(){this.encloseSelection("","",(e=>`> ${e.replace(/\r/g,"").replace(/\n/g,"\n> ")}`))},markdown(){this.encloseSelection("\n","",(e=>`> ${e.replace(/\r/g,"").replace(/\n/g,"\n> ")}`))}}},link:{type:"button",title:"Link",fn:{async wiki(){await this.elements.link.prompt.call(this,(e=>{if(!e)return;let t=`|${e.href}`;e.hreflang&&(t=`${t}|${e.hreflang}`),e.title&&(e.hreflang||(t=`${t}|`),t=`${t}|${e.title}`),t=`${t}]`,this.encloseSelection("[",t)}))},async markdown(){await this.elements.link.prompt.call(this,(e=>{if(!e)return;let t=`](${e.href}`;e.title&&(t=`${t} "${e.title}"`),t=`${t})`,e.hreflang&&(t=`${t}{hreflang=${e.hreflang}}`),this.encloseSelection("[",t)}))}},async prompt(e=null){const t=new dotclear.jsDialog({confirm_label:this.language_dialog.ok,cancel_label:this.language_dialog.cancel,fields:[{default:this.link_dialog.default_href,html:this.link_dialog.href},{default:this.link_dialog.default_title,html:this.link_dialog.title},{default:this.link_dialog.default_hreflang,html:this.link_dialog.language}]});await t.prompt().then((t=>{if(t&&e){const s=JSON.parse(t);s[0]&&e({href:this.stripBaseURL(s[0]),title:s[1],hreflang:s[2]})}}))}}},l&&dotclear.mergeDeep(this.elements,l),window.addEventListener("resize",(()=>{void 0!==dotclear.resizeTimer&&clearTimeout(dotclear.resizeTimer),dotclear.resizeTimer=setTimeout((()=>{document.documentElement.clientWidth!==dotclear.prevWidth&&(this.updateTooltipsPos(),dotclear.prevWidth=document.documentElement.clientWidth)}),250)}))))}getMode(){return this.mode}setMode(e){this.mode=e||"wiki"}switchMode(e="wiki"){this.draw(e)}button(e){const t=this.elements[e];return"function"!=typeof t.fn[this.mode]?null:new dotclear.jsButton(t.title,t.fn[this.mode],this,`jstb_${e}`)}space(e){const t=new dotclear.jsSpace(e);return void 0!==this.elements[e].width&&(t.width=this.elements[e].width),t}combo(e){const t=this.elements[e],s=t[this.mode].list.length;if("function"!=typeof t[this.mode].fn||0===s)return null;const i={};for(const e of t[this.mode].list)i[e]=t.options[e];return new dotclear.jsCombo(t.title,i,this,t[this.mode].fn)}draw(e){for(this.setMode(e);this.toolbar.hasChildNodes();)this.toolbar.removeChild(this.toolbar.firstChild);this.toolNodes={};for(const e in this.elements){const t=this.elements[e],s=void 0===t.type||""===t.type||void 0!==t.disabled&&t.disabled||void 0!==t.context&&null!=t.context&&t.context!==this.context;if(!s&&"function"==typeof this[t.type]){const s=this[t.type](e);if(s){const t=s.draw();t&&(this.toolNodes[e]=t,this.toolbar.appendChild(t),t.toolbarNode=this)}}}this.firstItem=document.querySelector(".jstElements button:first-child"),this.lastItem=document.querySelector(".jstElements button:last-child"),this.items=Array.from(document.querySelectorAll(".jstElements button")),this.updateTooltipsPos(),document.body.addEventListener("keydown",this.keyDown.bind(this))}keyDown(e){27===e.keyCode&&this.hideAllTooltips()}singleTag(e=null,t=e){e&&t&&this.encloseSelection(e,t)}encloseSelection(e="",t="",s=null){let i,l,n,o,a,r;this.textarea.focus(),void 0!==document.selection?n=document.selection.createRange().text:void 0!==this.textarea.setSelectionRange&&(i=this.textarea.selectionStart,l=this.textarea.selectionEnd,o=this.textarea.scrollTop,n=this.textarea.value.substring(i,l));let c=t;n.match(/ $/)&&(n=n.substring(0,n.length-1),c+=" "),r="function"==typeof s?n?s.call(this,n):s(""):n||"",a=e+r+c,void 0!==document.selection?(document.selection.createRange().text=a,this.textarea.caretPos-=t.length):void 0!==this.textarea.setSelectionRange&&(this.textarea.value=this.textarea.value.substring(0,i)+a+this.textarea.value.substring(l),r.length?this.textarea.setSelectionRange(i+a.length,i+a.length):this.textarea.setSelectionRange(i+e.length,i+e.length),this.textarea.scrollTop=o)}stripBaseURL(e){return""!==this.base_url&&0===e.indexOf(this.base_url)?e.substring(this.base_url.length):e}moveFocus(e,t){let s;s="previous"===t?e===this.firstItem?this.lastItem:this.items[this.items.indexOf(e)-1]:e===this.lastItem?this.firstItem:this.items[this.items.indexOf(e)+1],s.focus()}updateTooltipsPos(){for(const e of document.querySelectorAll(".jstElements button span")){if(e.classList.contains("jstb_icon"))continue;const t=e.parentNode.getBoundingClientRect().left;e.style.left="0px",e.classList.add("hidden"),e.classList.remove("sr-only");const s=e.clientWidth;if(e.classList.add("sr-only"),e.classList.remove("hidden"),s+t>document.documentElement.clientWidth-15){const i=Math.trunc(-1*(s+t-document.documentElement.clientWidth+15));e.style.left=`${i}px`}}}hideAllTooltips(){for(const e of document.querySelectorAll(".jstElements button span"))e.classList.contains("jstb_icon")||e.classList.add("sr-only")}};
