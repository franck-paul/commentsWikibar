"use strict";void 0===window.dotclear&&(window.dotclear={}),dotclear.wikibar={resize_timer:void 0,previous_width:0,component:{dialog:class{title;confirm_label;cancel_label;fields;constructor({title:e,confirm_label:t,cancel_label:i,fields:s}={}){this.title=e,this.confirm_label=t??"Ok",this.cancel_label=i??"Cancel",this.fields=s}prompt(){if(!this.fields?.length)return Promise.resolve(null);const e=document.createElement("template"),t=this.fields.map(e=>`<p class="field">${e.html}</p>`).join(""),i=this.title?`<h1>${this.title}</h1>`:"";e.innerHTML=((e,...t)=>e.reduce((e,i,s)=>e+i+(t[s]??""),""))`
          <dialog class="jstDialog">
            ${i}
            <form method="dialog">
              ${t}
              <p class="form-buttons">
                <button name="cancel" class="reset">${this.cancel_label}</button>
                <button type="submit" name="confirm" class="submit">${this.confirm_label}</button>
              </p>
            </form>
          </dialog>
        `;const s=e.content.firstElementChild,l=s.querySelectorAll(".field input, .field select");let n=0;for(const e of l)this.fields[n]?.default&&(e.value=this.fields[n].default),n++;document.body.appendChild(s);const o=()=>JSON.stringify([...l].map(e=>e.value));return new Promise(e=>{for(const e of l)e.addEventListener("keydown",e=>{"Enter"===e.key&&(e.preventDefault(),s.returnValue=o(),s.close())});s.querySelector('button[name="confirm"]')?.addEventListener("click",e=>{e.preventDefault(),s.returnValue=o(),s.close()}),s.querySelector('button[name="cancel"]')?.addEventListener("click",()=>{s.dispatchEvent(new Event("cancel"))}),s.addEventListener("cancel",function t(i){i.preventDefault(),s.removeEventListener("close",t),s.returnValue=null,s.remove(),e(null)}),s.addEventListener("close",function t(i){i.preventDefault(),s.removeEventListener("close",t);const l=s.returnValue;s.remove(),e(l)}),s.showModal(),l[0].focus()})}},button:class{title;fn;scope;className;toolbar_node=null;constructor(e,t,i,s){this.title=e??"",this.fn=t??(()=>{}),this.scope=i,this.className=s??null}draw(){if(!this.scope)return null;const e=document.createElement("button");e.setAttribute("type","button"),this.className&&(e.className=this.className);const t=document.createElement("span");t.className="sr-only",t.appendChild(document.createTextNode(this.title)),e.appendChild(t);const i=document.createElement("span");return i.className="jstb_icon",i.addEventListener("mouseover",this.mouseOverChild),i.addEventListener("mouseLeave",this.mouseLeaveChild),e.appendChild(i),e.addEventListener("keydown",this.keyDown),e.addEventListener("focus",this.focus),e.addEventListener("blur",this.blur),e.addEventListener("mouseover",this.mouseOver),e.addEventListener("mouseleave",this.mouseLeave),"function"==typeof this.fn&&e.addEventListener("click",e=>{try{this.fn.call(this.scope,e)}catch(e){console.log(e)}}),e}keyDown(e){let t=!1;switch(e.code){case"Enter":case"Space":default:break;case"ArrowRight":case"ArrowDown":this.toolbar_node.moveFocus(this,"next"),t=!0;break;case"ArrowLeft":case"ArrowUp":this.toolbar_node.moveFocus(this,"previous"),t=!0;break;case"Home":this.toolbar_node.firstItem.focus(),t=!0;break;case"End":this.toolbar_node.lastItem.focus(),t=!0}t&&(e.stopPropagation(),e.preventDefault())}blur(e){e.target.firstChild.classList.add("sr-only"),document.querySelector(".jstElements").classList.remove("focus")}focus(e){this.toolbar_node.hideAllTooltips(),e.target.firstChild.classList.remove("sr-only"),document.querySelector(".jstElements").classList.add("focus")}mouseLeave(e){"BUTTON"===e.target.nodeName&&(e.target.classList.remove("hovered"),setTimeout(()=>{e.target.classList.contains("hovered")||e.target.firstChild.classList.add("sr-only")},800))}mouseLeaveChild(e){if("SPAN"!==e.target.nodeName||!e.target.classList.contains("jstb_icon"))return;const t=e.target.parentNode;t.classList.remove("hovered"),setTimeout(()=>{t.classList.contains("hovered")||t.firstChild.classList.add("sr-only")},800)}mouseOver(e){"BUTTON"===e.target.nodeName&&(this.toolbar_node.hideAllTooltips(),e.target.firstChild.classList.remove("sr-only"),e.target.classList.add("hovered"))}mouseOverChild(e){if("SPAN"!==e.target.nodeName||!e.target.classList.contains("jstb_icon"))return;const t=e.target.parentNode;this.parentNode.toolbar_node.hideAllTooltips(),t.firstChild.classList.remove("sr-only"),t.classList.add("hovered")}},space:class{id=null;width=null;constructor(e){this.id=e??null}draw(){const e=document.createElement("span");return e.id=this.id??void 0,e.textContent=" ",e.setAttribute("aria-hidden","true"),e.className="jstSpacer",null!==this.width&&(e.style.marginRight=`${this.width}px`),e}},combo:class{title;options;scope;fn;className;toolbar_node=null;constructor(e,t,i,s,l){this.title=e??null,this.options=t,this.scope=i,this.fn=s??(()=>{}),this.className=l??null}draw(){if(!this.scope||!this.options)return null;const e=document.createElement("select");this.className&&(e.className=this.className),e.title=this.title;for(const t in this.options){const i=document.createElement("option");i.value=t,i.appendChild(document.createTextNode(this.options[t])),e.appendChild(i)}const t=this;return e.onchange=function(){try{t.fn.call(t.scope,this.value)}catch(e){window.alert(e)}return!1},e}}},toolbar:class{constructor(e,t="",i="wiki",s="",l=null,n={}){document.createElement&&e&&(void 0===document.selection&&void 0===e.setSelectionRange||(this.textarea=e,this.base_url=t,this.mode=i,this.label=s,this.foreign_dialog=n?.foreign,this.link_dialog=n?.link,this.cite_dialog=n?.cite,this.editor=document.createElement("div"),this.editor.className="jstEditor",this.textarea.parentNode.insertBefore(this.editor,this.textarea),this.editor.appendChild(this.textarea),this.toolbar=document.createElement("div"),this.toolbar.className="jstElements",this.toolbar.setAttribute("role","toolbar"),this.toolbar.setAttribute("aria-label",this.label),this.toolbar.setAttribute("aria-controls","c_content"),this.editor.parentNode.insertBefore(this.toolbar,this.editor),this.context=null,this.elements={strong:{type:"button",title:"Strong emphasis",fn:{wiki(){this.singleTag("__")},markdown(){this.singleTag("**")}}},em:{type:"button",title:"Emphasis",fn:{wiki(){this.singleTag("''")},markdown(){this.singleTag("*")}}},ins:{type:"button",title:"Inserted",fn:{wiki(){this.singleTag("++")},markdown(){this.singleTag("<ins>","</ins>")}}},del:{type:"button",title:"Deleted",fn:{wiki(){this.singleTag("--")},markdown(){this.singleTag("<del>","</del>")}}},quote:{type:"button",title:"Inline quote",fn:{async wiki(){await this.elements.quote.prompt.call(this,e=>{let t="";e.lang&&(t=`${t}|${e.lang}`),e.cite&&(e.lang||(t=`${t}|`),t=`${t}|${e.cite}`),t=`${t}}}`,this.encloseSelection("{{",t)})},async markdown(){await this.elements.quote.prompt.call(this,e=>{let t="<q";e.cite&&(t=`${t} cite="${e.cite}"`),e.lang&&(t=`${t} lang="${e.lang}"`),t=`${t}>`,this.encloseSelection(t,"</q>")})}},async prompt(e=null){const t=new dotclear.wikibar.component.dialog({title:this.cite_dialog?.title||this.title,confirm_label:this.cite_dialog.ok,cancel_label:this.cite_dialog.cancel,fields:[{default:this.cite_dialog.fields.default_url,html:this.cite_dialog.fields.url},{default:this.cite_dialog.fields.default_lang,html:this.cite_dialog.fields.language}]});await t.prompt().then(t=>{if(t&&e){const i=JSON.parse(t);return void e({cite:this.stripBaseURL(i[0]),lang:i[1]})}this.toolbar.querySelector(".jstb_quote").focus()})}},code:{type:"button",title:"Code",fn:{wiki(){this.singleTag("@@")},markdown(){this.singleTag("`")}}},foreign:{type:"button",title:"Foreign text",fn:{async wiki(){await this.elements.foreign.prompt.call(this,e=>{this.encloseSelection("££",`|${e.lang}££`)})},async markdown(){await this.elements.foreign.prompt.call(this,e=>{this.encloseSelection(`<i lang="${e.lang}">`,"</i>")})}},async prompt(e=null){const t=new dotclear.wikibar.component.dialog({title:this.foreign_dialog?.title||this.title,confirm_label:this.foreign_dialog.ok,cancel_label:this.foreign_dialog.cancel,fields:[{default:this.foreign_dialog.fields.default_lang,html:this.foreign_dialog.fields.language}]});await t.prompt().then(t=>{if(t&&e){const i=JSON.parse(t);return void e({lang:i[0]})}this.toolbar.querySelector(".jstb_foreign").focus()})}},space_inline:{type:"space"},br:{type:"button",title:"Line break",fn:{wiki(){this.encloseSelection("%%%\n","")},markdown(){this.encloseSelection("  \n","")}}},space_br:{type:"space"},ul:{type:"button",title:"Unordered list",fn:{wiki(){this.encloseSelection("","",e=>`* ${e.replace(/\r/g,"").replace(/\n/g,"\n* ")}`)},markdown(){this.encloseSelection("","",e=>`* ${e.replace(/\r/g,"").replace(/\n/g,"\n* ")}`)}}},ol:{type:"button",title:"Ordered list",fn:{wiki(){this.encloseSelection("","",e=>`# ${e.replace(/\r/g,"").replace(/\n/g,"\n# ")}`)},markdown(){this.encloseSelection("","",e=>`1. ${e.replace(/\r/g,"").replace(/\n/g,"\n1. ")}`)}}},space_list:{type:"space"},pre:{type:"button",title:"Preformatted",fn:{wiki(){this.encloseSelection("","",e=>` ${e.replace(/\r/g,"").replace(/\n/g,"\n ")}`)},markdown(){this.encloseSelection("\n","",e=>`    ${e.replace(/\r/g,"").replace(/\n/g,"\n    ")}`)}}},bquote:{type:"button",title:"Block quote",fn:{wiki(){this.encloseSelection("","",e=>`> ${e.replace(/\r/g,"").replace(/\n/g,"\n> ")}`)},markdown(){this.encloseSelection("\n","",e=>`> ${e.replace(/\r/g,"").replace(/\n/g,"\n> ")}`)}}},space_block:{type:"space"},link:{type:"button",title:"Link",fn:{async wiki(){await this.elements.link.prompt.call(this,e=>{if(!e)return;let t=`|${e.href}`;e.hreflang&&(t=`${t}|${e.hreflang}`),e.title&&(e.hreflang||(t=`${t}|`),t=`${t}|${e.title}`),t=`${t}]`,this.encloseSelection("[",t)})},async markdown(){await this.elements.link.prompt.call(this,e=>{if(!e)return;let t=`](${e.href}`;e.title&&(t=`${t} "${e.title}"`),t=`${t})`,e.hreflang&&(t=`${t}{hreflang=${e.hreflang}}`),this.encloseSelection("[",t)})}},async prompt(e=null){const t=new dotclear.wikibar.component.dialog({title:this.link_dialog?.title||this.title,confirm_label:this.link_dialog.ok,cancel_label:this.link_dialog.cancel,fields:[{default:this.link_dialog.fields.default_href,html:this.link_dialog.fields.href},{default:this.link_dialog.fields.default_title,html:this.link_dialog.fields.title},{default:this.link_dialog.fields.default_hreflang,html:this.link_dialog.fields.language}]});await t.prompt().then(t=>{if(t&&e){const i=JSON.parse(t);if(i[0])return void e({href:this.stripBaseURL(i[0]),title:i[1],hreflang:i[2]})}this.toolbar.querySelector(".jstb_link").focus()})}}},l&&dotclear.mergeDeep(this.elements,l),window.addEventListener("resize",()=>{clearTimeout(dotclear.resize_timer),dotclear.resize_timer=setTimeout(()=>{document.documentElement.clientWidth!==dotclear.wikibar.previous_width&&(this.updateTooltipsPos(),dotclear.wikibar.previous_width=document.documentElement.clientWidth)},250)})))}getMode(){return this.mode}setMode(e){this.mode=e??"wiki"}switchMode(e="wiki"){this.draw(e)}button(e){const t=this.elements[e];return"function"!=typeof t.fn[this.mode]?null:new dotclear.wikibar.component.button(t.title,t.fn[this.mode],this,`jstb_${e}`)}space(e){const t=new dotclear.wikibar.component.space(e);return void 0!==this.elements[e].width&&(t.width=this.elements[e].width),t}combo(e){const t=this.elements[e];if("function"!=typeof t[this.mode].fn||0===t[this.mode].list.length)return null;const i={};for(const e of t[this.mode].list)i[e]=t.options[e];return new dotclear.wikibar.component.combo(t.title,i,this,t[this.mode].fn)}draw(e){for(this.setMode(e);this.toolbar.hasChildNodes();)this.toolbar.removeChild(this.toolbar.firstChild);let t,i=[];for(const e in this.elements){const s=this.elements[e],l=!s||void 0===s.type||""===s.type||void 0!==s.disabled&&s.disabled||void 0!==s.context&&null!=s.context&&s.context!==this.context;if(!l&&"function"==typeof this[s.type]){const l=this[s.type](e);if(l){const e=l.draw();e&&("space"===s.type&&"space"===t?.type||(i.push({type:s.type,node:e}),e.toolbar_node=this,t=s))}}}if(0===i.length)return;let s=0;for(;i.length>0&&"space"===i[s].type;)i=i.slice(1);for(s=i.length-1;s>=0&&s<i.length&&"space"===i[s].type;)i=i.slice(0,-1),s--;for(const e of i)this.toolbar.appendChild(e.node);this.firstItem=document.querySelector(".jstElements button:first-child"),this.lastItem=document.querySelector(".jstElements button:last-child"),this.items=Array.from(document.querySelectorAll(".jstElements button")),this.updateTooltipsPos(),document.body.addEventListener("keydown",this.keyDown.bind(this))}keyDown(e){"Escape"===e.code&&this.hideAllTooltips()}singleTag(e=null,t=e){e&&t&&this.encloseSelection(e,t)}encloseSelection(e="",t="",i=null){let s,l,n,o,a,r;this.textarea.focus(),void 0!==document.selection?n=document.selection.createRange().text:void 0!==this.textarea.setSelectionRange&&(s=this.textarea.selectionStart,l=this.textarea.selectionEnd,o=this.textarea.scrollTop,n=this.textarea.value.substring(s,l));let c=t;n.match(/ $/)&&(n=n.substring(0,n.length-1),c+=" "),r="function"==typeof i?n?i.call(this,n):i(""):n||"",a=e+r+c,void 0!==document.selection?(document.selection.createRange().text=a,this.textarea.caretPos-=t.length):void 0!==this.textarea.setSelectionRange&&(this.textarea.value=this.textarea.value.substring(0,s)+a+this.textarea.value.substring(l),r.length?this.textarea.setSelectionRange(s+a.length,s+a.length):this.textarea.setSelectionRange(s+e.length,s+e.length),this.textarea.scrollTop=o)}stripBaseURL(e){return""!==this.base_url&&0===e.indexOf(this.base_url)?e.substring(this.base_url.length):e}moveFocus(e,t){let i;i="previous"===t?e===this.firstItem?this.lastItem:this.items[this.items.indexOf(e)-1]:e===this.lastItem?this.firstItem:this.items[this.items.indexOf(e)+1],i.focus()}updateTooltipsPos(){for(const e of document.querySelectorAll(".jstElements button span")){if(e.classList.contains("jstb_icon"))continue;const t=e.parentNode.getBoundingClientRect().left;e.style.left="0px",e.classList.add("hidden"),e.classList.remove("sr-only");const i=e.clientWidth;if(e.classList.add("sr-only"),e.classList.remove("hidden"),i+t>document.documentElement.clientWidth-15){const s=Math.trunc(-1*(i+t-document.documentElement.clientWidth+15));e.style.left=`${s}px`}}}hideAllTooltips(){for(const e of document.querySelectorAll(".jstElements button span"))e.classList.contains("jstb_icon")||e.classList.add("sr-only")}}};
